{% extends "base.html" %}

{% block title %}Bucket Management - User Dashboard{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-8">
    <!-- Header -->
    <div class="mb-8">
        <h2 class="text-3xl font-bold text-gray-900 mb-2">Bucket Management</h2>
        <p class="text-gray-600">Request and manage your bucket access</p>
    </div>

    <!-- Tabs -->
    <div class="mb-6 border-b border-gray-200">
        <div class="flex gap-8">
            <button onclick="switchTab('request')" id="request-tab" class="tab-button active pb-4 px-2 border-b-2 border-purple-600 text-purple-600 font-medium">
                Request Bucket
            </button>
            <button onclick="switchTab('requests')" id="requests-tab" class="tab-button pb-4 px-2 border-b-2 border-transparent text-gray-600 font-medium hover:text-gray-900">
                My Requests
                <span id="requests-count" class="bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-0.5 rounded-full ml-2">0</span>
            </button>
            <button onclick="switchTab('buckets')" id="buckets-tab" class="tab-button pb-4 px-2 border-b-2 border-transparent text-gray-600 font-medium hover:text-gray-900">
                Approved Buckets
                <span id="buckets-count" class="bg-green-100 text-green-800 text-xs font-semibold px-2.5 py-0.5 rounded-full ml-2">0</span>
            </button>
        </div>
    </div>

    <!-- Request Bucket Tab -->
    <div id="request-tab-content" class="tab-content">
        <div class="bg-white rounded-lg shadow p-6 max-w-2xl">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Request Bucket Access</h3>

            <div class="space-y-4">
                <div>
                    <label for="provider-select" class="block text-sm font-medium text-gray-700 mb-1">Storage Provider</label>
                    <select id="provider-select" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <option value="">-- Select Provider --</option>
                    </select>
                </div>

                <div>
                    <label for="bucket-name" class="block text-sm font-medium text-gray-700 mb-1">Bucket Name</label>
                    <input type="text" id="bucket-name" placeholder="e.g., project-alpha-data" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>

                <div>
                    <label for="request-type" class="block text-sm font-medium text-gray-700 mb-1">Request Type</label>
                    <div class="space-y-2">
                        <label class="flex items-center">
                            <input type="radio" name="request-type" value="create" checked class="text-purple-600">
                            <span class="ml-2 text-gray-700">Create New Bucket</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="request-type" value="delete" class="text-purple-600">
                            <span class="ml-2 text-gray-700">Delete Bucket</span>
                        </label>
                    </div>
                </div>

                <button onclick="submitBucketRequest()" class="w-full px-4 py-2 bg-purple-600 text-white rounded-lg font-medium hover:bg-purple-700 transition">
                    Submit Request
                </button>
            </div>

            <div id="request-message" class="hidden mt-4 p-4 rounded-lg"></div>
        </div>
    </div>

    <!-- My Requests Tab -->
    <div id="requests-tab-content" class="tab-content hidden">
        <div class="space-y-4">
            <div id="requests-loading" class="text-center py-12">
                <div class="inline-block">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600"></div>
                </div>
            </div>
            <div id="requests-list" class="hidden space-y-4"></div>
            <div id="requests-empty" class="hidden text-center py-12">
                <p class="text-gray-500">No requests yet</p>
            </div>
        </div>
    </div>

    <!-- Approved Buckets Tab -->
    <div id="buckets-tab-content" class="tab-content hidden">
        <div class="space-y-4">
            <div id="buckets-loading" class="text-center py-12">
                <div class="inline-block">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600"></div>
                </div>
            </div>
            <div id="buckets-list" class="hidden space-y-4"></div>
            <div id="buckets-empty" class="hidden text-center py-12">
                <p class="text-gray-500">No approved buckets yet</p>
            </div>
        </div>
    </div>
</div>

<script>
let providers = [];

document.addEventListener('DOMContentLoaded', function() {
    loadProviders();
});

function loadProviders() {
    axios.get('/user/providers')
        .then(response => {
            if (response.data.success) {
                providers = response.data.providers;
                const select = document.getElementById('provider-select');
                select.innerHTML = '<option value="">-- Select Provider --</option>' +
                    providers.map(p => `<option value="${p.id}">${p.display_name} (${p.type_label})</option>`).join('');
            }
        })
        .catch(error => console.error('Error loading providers:', error));
}

function submitBucketRequest() {
    const providerId = document.getElementById('provider-select').value;
    const bucketName = document.getElementById('bucket-name').value;
    const requestType = document.querySelector('input[name="request-type"]:checked').value;

    if (!providerId) {
        showRequestMessage('Please select a provider', 'error');
        return;
    }

    if (!bucketName.trim()) {
        showRequestMessage('Please enter a bucket name', 'error');
        return;
    }

    axios.post('/user/request-bucket', {
        provider_id: parseInt(providerId),
        bucket_name: bucketName,
        request_type: requestType
    })
        .then(response => {
            if (response.data.success) {
                showRequestMessage(response.data.message, 'success');
                document.getElementById('bucket-name').value = '';
                setTimeout(() => {
                    switchTab('requests');
                    loadUserRequests();
                }, 1500);
            }
        })
        .catch(error => {
            const message = error.response?.data?.error || 'Failed to submit request';
            showRequestMessage(message, 'error');
        });
}

function loadUserRequests() {
    document.getElementById('requests-loading').classList.remove('hidden');
    document.getElementById('requests-list').classList.add('hidden');
    document.getElementById('requests-empty').classList.add('hidden');

    axios.get('/user/bucket-requests')
        .then(response => {
            if (response.data.success) {
                document.getElementById('requests-count').textContent = response.data.count;
                const requests = response.data.requests;

                document.getElementById('requests-loading').classList.add('hidden');

                if (requests.length > 0) {
                    document.getElementById('requests-list').innerHTML = requests.map(req => `
                        <div class="bg-white rounded-lg shadow p-4 border-l-4 ${getBorderColor(req.status)}">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <h4 class="font-semibold text-gray-900">${req.bucket_name}</h4>
                                    <p class="text-sm text-gray-600">${req.provider_name}</p>
                                </div>
                                <span class="px-3 py-1 rounded-full text-sm font-medium ${getStatusBadge(req.status)}">
                                    ${req.status.charAt(0).toUpperCase() + req.status.slice(1)}
                                </span>
                            </div>

                            <div class="grid grid-cols-2 gap-4 text-sm mb-2">
                                <div>
                                    <span class="text-gray-600">Type:</span>
                                    <p class="font-medium text-gray-900">${req.request_type.charAt(0).toUpperCase() + req.request_type.slice(1)}</p>
                                </div>
                                <div>
                                    <span class="text-gray-600">Requested:</span>
                                    <p class="font-medium text-gray-900">${new Date(req.created_at).toLocaleDateString()}</p>
                                </div>
                            </div>

                            ${req.admin_notes ? `
                                <div class="mt-2 p-2 bg-yellow-50 border border-yellow-200 rounded text-sm text-yellow-800">
                                    <strong>Admin Notes:</strong> ${req.admin_notes}
                                </div>
                            ` : ''}
                        </div>
                    `).join('');
                    document.getElementById('requests-list').classList.remove('hidden');
                } else {
                    document.getElementById('requests-empty').classList.remove('hidden');
                }
            } else {
                document.getElementById('requests-loading').classList.add('hidden');
                document.getElementById('requests-empty').classList.remove('hidden');
            }
        })
        .catch(error => {
            console.error('Error loading requests:', error);
            document.getElementById('requests-loading').classList.add('hidden');
            document.getElementById('requests-empty').classList.remove('hidden');
        });
}

function loadManagedBuckets() {
    document.getElementById('buckets-loading').classList.remove('hidden');
    document.getElementById('buckets-list').classList.add('hidden');
    document.getElementById('buckets-empty').classList.add('hidden');

    axios.get('/user/managed-buckets')
        .then(response => {
            if (response.data.success) {
                document.getElementById('buckets-count').textContent = response.data.count;
                const buckets = response.data.buckets;

                document.getElementById('buckets-loading').classList.add('hidden');

                if (buckets.length > 0) {
                    document.getElementById('buckets-list').innerHTML = buckets.map(bucket => `
                        <div class="bg-white rounded-lg shadow p-4 border-l-4 border-green-500">
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <h4 class="font-semibold text-gray-900">${bucket.bucket_name}</h4>
                                    <p class="text-sm text-gray-600">${bucket.provider_name}</p>
                                </div>
                                <span class="px-3 py-1 rounded-full text-sm font-medium ${bucket.is_applied ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                                    ${bucket.is_applied ? 'Active' : 'Pending'}
                                </span>
                            </div>

                            <div class="mb-3">
                                <label class="text-sm font-medium text-gray-700">Allowed Actions:</label>
                                <div class="mt-2 flex flex-wrap gap-2">
                                    ${getActionBadges(bucket.allowed_actions)}
                                </div>
                            </div>

                            <div class="text-xs text-gray-500">
                                Approved: ${new Date(bucket.created_at).toLocaleDateString()}
                            </div>
                        </div>
                    `).join('');
                    document.getElementById('buckets-list').classList.remove('hidden');
                } else {
                    document.getElementById('buckets-empty').classList.remove('hidden');
                }
            }
        })
        .catch(error => console.error('Error loading buckets:', error));
}

function switchTab(tab) {
    document.querySelectorAll('.tab-content').forEach(el => {
        el.classList.add('hidden');
    });

    document.querySelectorAll('.tab-button').forEach(el => {
        el.classList.remove('border-purple-600', 'text-purple-600');
        el.classList.add('border-transparent', 'text-gray-600');
    });

    document.getElementById(`${tab}-tab-content`).classList.remove('hidden');
    document.getElementById(`${tab}-tab`).classList.remove('border-transparent', 'text-gray-600');
    document.getElementById(`${tab}-tab`).classList.add('border-purple-600', 'text-purple-600');

    if (tab === 'requests') {
        loadUserRequests();
    } else if (tab === 'buckets') {
        loadManagedBuckets();
    }
}

function showRequestMessage(message, type) {
    const messageEl = document.getElementById('request-message');
    messageEl.textContent = message;
    messageEl.className = `mt-4 p-4 rounded-lg ${type === 'success' ? 'bg-green-50 border border-green-200 text-green-800' : 'bg-red-50 border border-red-200 text-red-800'}`;
    messageEl.classList.remove('hidden');
    setTimeout(() => messageEl.classList.add('hidden'), 4000);
}

function getBorderColor(status) {
    switch(status) {
        case 'pending': return 'border-blue-500';
        case 'approved': return 'border-green-500';
        case 'rejected': return 'border-red-500';
        default: return 'border-gray-500';
    }
}

function getStatusBadge(status) {
    switch(status) {
        case 'pending': return 'bg-blue-100 text-blue-800';
        case 'approved': return 'bg-green-100 text-green-800';
        case 'rejected': return 'bg-red-100 text-red-800';
        default: return 'bg-gray-100 text-gray-800';
    }
}

function getActionBadges(actions) {
    const actionLabels = {
        's3:GetObject': 'Read',
        's3:PutObject': 'Write',
        's3:DeleteObject': 'Delete',
        's3:ListBucket': 'List'
    };

    return actions.map(action => {
        const label = actionLabels[action] || action;
        return `<span class="px-2 py-1 bg-purple-100 text-purple-800 text-xs font-medium rounded">${label}</span>`;
    }).join('');
}
</script>

<style>
.tab-button {
    transition: all 0.3s ease;
}
</style>
{% endblock %}
