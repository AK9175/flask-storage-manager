{% extends "base.html" %}

{% block title %}Bucket Requests - Storage Manager{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-8">
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Bucket Access Management</h1>
        <p class="text-gray-600">Request, manage, and monitor your bucket access</p>
    </div>

    <!-- Tabs -->
    <div class="bg-white rounded-lg shadow">
        <div class="border-b border-gray-200">
            <div class="flex gap-0">
                <button class="tab-button px-6 py-4 border-b-2 border-purple-600 text-purple-600 font-medium" data-tab="request">
                    Request Bucket
                </button>
                <button class="tab-button px-6 py-4 border-b-2 border-transparent text-gray-600 font-medium" data-tab="my-requests">
                    My Requests
                </button>
                <button class="tab-button px-6 py-4 border-b-2 border-transparent text-gray-600 font-medium" data-tab="managed">
                    Approved Buckets
                </button>
            </div>
        </div>

        <!-- Request Tab -->
        <div id="tab-request" class="tab-content p-6">
            <h2 class="text-xl font-bold mb-6">Request Access to a Bucket</h2>
            
            <form id="bucket-request-form" class="max-w-2xl space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Storage Provider</label>
                    <select id="provider-select" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600 focus:border-transparent">
                        <option value="">-- Select a provider --</option>
                    </select>
                    <p class="mt-1 text-sm text-gray-500">Choose which cloud storage provider you want to use</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Bucket Name</label>
                    <input type="text" id="bucket-name" placeholder="e.g., my-documents" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600 focus:border-transparent">
                    <p class="mt-1 text-sm text-gray-500">Enter the name of the bucket you want to access</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Request Type</label>
                    <div class="space-y-2">
                        <label class="flex items-center">
                            <input type="radio" name="request-type" value="create" checked class="mr-2">
                            <span class="text-gray-700"><strong>Create:</strong> Create a new bucket</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="request-type" value="delete" class="mr-2">
                            <span class="text-gray-700"><strong>Delete:</strong> Delete an existing bucket</span>
                        </label>
                    </div>
                </div>

                <button type="submit" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg">
                    Submit Request
                </button>
            </form>
        </div>

        <!-- My Requests Tab -->
        <div id="tab-my-requests" class="tab-content hidden p-6">
            <h2 class="text-xl font-bold mb-6">Your Bucket Requests</h2>
            
            <div class="flex gap-2 mb-6 border-b border-gray-200">
                <button class="request-filter px-4 py-2 border-b-2 border-purple-600 text-purple-600 font-medium" data-filter="all">
                    All <span class="ml-2 bg-gray-300 text-gray-700 rounded-full px-2 py-0.5 text-sm">0</span>
                </button>
                <button class="request-filter px-4 py-2 border-b-2 border-transparent text-gray-600" data-filter="pending">
                    Pending <span class="ml-2 bg-yellow-300 text-yellow-700 rounded-full px-2 py-0.5 text-sm">0</span>
                </button>
                <button class="request-filter px-4 py-2 border-b-2 border-transparent text-gray-600" data-filter="approved">
                    Approved <span class="ml-2 bg-green-300 text-green-700 rounded-full px-2 py-0.5 text-sm">0</span>
                </button>
                <button class="request-filter px-4 py-2 border-b-2 border-transparent text-gray-600" data-filter="rejected">
                    Rejected <span class="ml-2 bg-red-300 text-red-700 rounded-full px-2 py-0.5 text-sm">0</span>
                </button>
            </div>

            <div id="my-requests-container" class="space-y-4">
                <div class="text-center py-12 text-gray-500">Loading requests...</div>
            </div>
        </div>

        <!-- Approved Buckets Tab -->
        <div id="tab-managed" class="tab-content hidden p-6">
            <h2 class="text-xl font-bold mb-6">Your Approved Buckets</h2>
            
            <div id="approved-buckets-container" class="space-y-4">
                <div class="text-center py-12 text-gray-500">Loading approved buckets...</div>
            </div>
        </div>
    </div>
</div>

<!-- Messages -->
<div id="success-message" class="fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded shadow-lg hidden"></div>
<div id="error-message" class="fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded shadow-lg hidden"></div>

<script>
    let currentRequestFilter = 'all';

    // Tab switching
    document.querySelectorAll('.tab-button').forEach(button => {
        button.addEventListener('click', function() {
            const tab = this.dataset.tab;
            
            document.querySelectorAll('.tab-button').forEach(b => {
                b.classList.remove('border-purple-600', 'text-purple-600');
                b.classList.add('border-transparent', 'text-gray-600');
            });
            this.classList.add('border-purple-600', 'text-purple-600');
            this.classList.remove('border-transparent', 'text-gray-600');
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(`tab-${tab}`).classList.remove('hidden');
            
            if (tab === 'my-requests') {
                loadMyRequests();
            } else if (tab === 'managed') {
                loadApprovedBuckets();
            }
        });
    });

    // Request filter
    document.querySelectorAll('.request-filter').forEach(button => {
        button.addEventListener('click', function() {
            document.querySelectorAll('.request-filter').forEach(b => {
                b.classList.remove('border-purple-600', 'text-purple-600');
                b.classList.add('border-transparent', 'text-gray-600');
            });
            this.classList.add('border-purple-600', 'text-purple-600');
            this.classList.remove('border-transparent', 'text-gray-600');
            
            currentRequestFilter = this.dataset.filter;
            loadMyRequests();
        });
    });

    // Show message
    function showMessage(message, isError = false) {
        const element = isError ? document.getElementById('error-message') : document.getElementById('success-message');
        element.textContent = message;
        element.classList.remove('hidden');
        setTimeout(() => element.classList.add('hidden'), 4000);
    }

    // Load providers
    async function loadProviders() {
        try {
            const response = await axios.get('/user/providers');
            const select = document.getElementById('provider-select');
            select.innerHTML = '<option value="">-- Select a provider --</option>';
            
            response.data.providers.forEach(provider => {
                const option = document.createElement('option');
                option.value = provider.id;
                option.textContent = `${provider.display_name} (${provider.type})`;
                select.appendChild(option);
            });
        } catch (error) {
            console.error('Error loading providers:', error);
        }
    }

    // Submit bucket request
    document.getElementById('bucket-request-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const providerId = document.getElementById('provider-select').value;
        const bucketName = document.getElementById('bucket-name').value;
        const requestType = document.querySelector('input[name="request-type"]:checked').value;
        
        try {
            const response = await axios.post('/user/request-bucket', {
                provider_id: parseInt(providerId),
                bucket_name: bucketName,
                request_type: requestType
            });
            
            showMessage(`âœ“ ${response.data.message}`);
            document.getElementById('bucket-request-form').reset();
            
            // Switch to my requests tab
            setTimeout(() => {
                document.querySelector('[data-tab="my-requests"]').click();
            }, 1000);
        } catch (error) {
            showMessage(error.response?.data?.error || 'Error submitting request', true);
        }
    });

    // Load my requests
    async function loadMyRequests() {
        try {
            const response = await axios.get('/user/bucket-requests');
            const requests = response.data.requests || [];
            const container = document.getElementById('my-requests-container');
            
            // Update counts
            document.querySelector('[data-filter="all"] span').textContent = requests.length;
            document.querySelector('[data-filter="pending"] span').textContent = requests.filter(r => r.status === 'pending').length;
            document.querySelector('[data-filter="approved"] span').textContent = requests.filter(r => r.status === 'approved').length;
            document.querySelector('[data-filter="rejected"] span').textContent = requests.filter(r => r.status === 'rejected').length;

            let filtered = requests;
            if (currentRequestFilter !== 'all') {
                filtered = requests.filter(r => r.status === currentRequestFilter);
            }

            if (filtered.length === 0) {
                container.innerHTML = `<div class="text-center py-12 text-gray-500">No ${currentRequestFilter === 'all' ? '' : currentRequestFilter} requests</div>`;
                return;
            }

            container.innerHTML = '';
            filtered.forEach(request => {
                const statusColor = 
                    request.status === 'pending' ? 'yellow' :
                    request.status === 'approved' ? 'green' : 'red';
                
                const card = document.createElement('div');
                card.className = `bg-white p-6 rounded-lg shadow border-l-4 border-${statusColor}-500`;
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-lg font-bold">${request.bucket_name}</h3>
                            <p class="text-gray-600 text-sm">${request.provider_name}</p>
                        </div>
                        <span class="px-3 py-1 bg-${statusColor}-100 text-${statusColor}-800 rounded text-sm font-medium">
                            ${request.status.charAt(0).toUpperCase() + request.status.slice(1)}
                        </span>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 py-4 border-y border-gray-200">
                        <div>
                            <p class="text-gray-600 text-sm">Type</p>
                            <p class="font-medium capitalize">${request.request_type}</p>
                        </div>
                        <div>
                            <p class="text-gray-600 text-sm">Date</p>
                            <p class="font-medium">${new Date(request.created_at).toLocaleDateString()}</p>
                        </div>
                    </div>

                    ${request.admin_notes ? `<div class="bg-blue-50 p-3 rounded mt-4"><p class="text-sm text-blue-900"><strong>Admin Notes:</strong> ${request.admin_notes}</p></div>` : ''}
                `;
                container.appendChild(card);
            });
        } catch (error) {
            console.error('Error loading requests:', error);
            showMessage('Error loading requests', true);
        }
    }

    // Load approved buckets
    async function loadApprovedBuckets() {
        try {
            const response = await axios.get('/user/managed-buckets');
            const buckets = response.data.managed_buckets || [];
            const container = document.getElementById('approved-buckets-container');

            if (buckets.length === 0) {
                container.innerHTML = '<div class="text-center py-12 text-gray-500">No approved buckets yet</div>';
                return;
            }

            container.innerHTML = '';
            buckets.forEach(bucket => {
                const card = document.createElement('div');
                card.className = 'bg-white p-6 rounded-lg shadow border-l-4 border-green-500';
                
                const actions = bucket.allowed_actions.map(a => 
                    `<span class="px-2 py-1 bg-green-100 text-green-800 rounded text-xs">${a}</span>`
                ).join('');
                
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-lg font-bold">${bucket.bucket_name}</h3>
                            <p class="text-gray-600 text-sm">${bucket.provider_name}</p>
                        </div>
                        <span class="px-3 py-1 bg-green-100 text-green-800 rounded text-sm font-medium">Active</span>
                    </div>
                    
                    <div class="py-4 border-y border-gray-200">
                        <p class="text-gray-600 text-sm mb-2">Allowed Actions:</p>
                        <div class="flex gap-2 flex-wrap">${actions}</div>
                    </div>
                `;
                container.appendChild(card);
            });
        } catch (error) {
            console.error('Error loading approved buckets:', error);
            showMessage('Error loading approved buckets', true);
        }
    }

    // Load providers on page load
    window.addEventListener('load', () => {
        loadProviders();
        loadMyRequests();
    });
</script>

<style>
    .border-yellow-500 { border-color: #eab308; }
    .bg-yellow-100 { background-color: #fef08a; }
    .text-yellow-800 { color: #713f12; }
    .bg-yellow-300 { background-color: #facc15; }
    .text-yellow-700 { color: #854d0e; }
</style>
{% endblock %}
