{% extends "base.html" %}

{% block title %}File Storage - Dashboard{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100">
    <!-- Header -->
    <div class="bg-white shadow-sm border-b border-slate-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-slate-900">File Storage & Bucket Management</h1>
                    <p class="mt-2 text-slate-600">Request buckets, manage access, and upload files</p>
                </div>
                <div class="text-right">
                    <p class="text-sm text-slate-600">Logged in as</p>
                    <p class="text-lg font-semibold text-slate-900">{{ current_user.email }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs -->
    <div class="bg-white border-b border-slate-200 sticky top-0 z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex gap-8">
                <button onclick="switchDashboardTab('buckets')" id="tab-buckets" 
                    class="px-4 py-4 border-b-2 border-blue-600 text-blue-600 font-medium text-sm">
                    Bucket Requests <span id="bucket-badge" class="ml-2 bg-blue-600 text-white px-2 py-0.5 rounded-full text-xs">0</span>
                </button>
                <button onclick="switchDashboardTab('files')" id="tab-files"
                    class="px-4 py-4 border-b-2 border-transparent text-slate-600 hover:text-slate-900 font-medium text-sm">
                    Upload & Browse Files
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Bucket Requests Tab -->
        <div id="bucket-tab" class="space-y-6">
            <!-- Go to Bucket Management -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
                <div class="flex items-start gap-4">
                    <div class="text-3xl">ü™£</div>
                    <div class="flex-1">
                        <h3 class="text-lg font-semibold text-slate-900 mb-2">Request Bucket Access</h3>
                        <p class="text-slate-600 mb-4">To upload files, you need to request access to storage buckets from administrators. Your requests will be reviewed and approved with specific permissions.</p>
                        <a href="{{ url_for('user_bucket_management_ui') }}" class="inline-block bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition">
                            Go to Bucket Management ‚Üí
                        </a>
                    </div>
                </div>
            </div>

            <!-- Approved Buckets List -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-xl font-bold text-slate-900 mb-4">‚úÖ Your Approved Buckets</h3>
                <div id="approvedBucketsList" class="space-y-3">
                    <p class="text-slate-500 text-center py-8">Loading buckets...</p>
                </div>
            </div>
        </div>

        <!-- Files Tab - Upload & Browse (Hidden by default) -->
        <div id="files-tab" class="hidden space-y-6">
            <!-- No Buckets Message -->
            <div id="noBucketsMessage" class="bg-amber-50 border border-amber-200 rounded-lg p-6 hidden">
                <div class="text-center">
                    <p class="text-lg text-slate-900 font-semibold mb-2">No Approved Buckets</p>
                    <p class="text-slate-600 mb-4">You need to request and get approval for buckets before you can upload files.</p>
                    <a href="{{ url_for('user_bucket_management_ui') }}" class="inline-block bg-amber-600 hover:bg-amber-700 text-white font-semibold py-2 px-4 rounded-lg transition">
                        Request a Bucket Now
                    </a>
                </div>
            </div>

            <!-- Provider Selection and Upload -->
            <div id="uploadSection" class="bg-white rounded-lg shadow-md p-6 hidden">
                <h2 class="text-2xl font-bold text-slate-900 mb-6">üì§ Upload File</h2>
                
                <form id="uploadForm" class="space-y-6">
                <!-- Provider Selection -->
                <div>
                    <label class="block text-sm font-medium text-slate-900 mb-2">
                        Select Storage Provider
                    </label>
                    <select id="providerSelect" required class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">-- Choose a provider --</option>
                    </select>
                    <p class="mt-2 text-sm text-slate-500">Select where you want to store your file</p>
                </div>

                <!-- Bucket Name - Select from Available Buckets -->
                <div>
                    <label class="block text-sm font-medium text-slate-900 mb-2">
                        Bucket/Container Name <span class="text-red-500">*</span>
                    </label>
                    <select 
                        id="bucketName" 
                        required 
                        class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    >
                        <option value="">-- Select an approved bucket --</option>
                    </select>
                    <p class="mt-2 text-sm text-slate-500">Select from your approved buckets (only available buckets are shown)</p>
                </div>

                <!-- File Input -->
                <div>
                    <label class="block text-sm font-medium text-slate-900 mb-2">
                        Choose File
                    </label>
                    <div class="border-2 border-dashed border-slate-300 rounded-lg p-6 text-center hover:border-blue-400 transition">
                        <input 
                            type="file" 
                            id="fileInput" 
                            required 
                            class="w-full"
                        >
                        <p class="mt-2 text-sm text-slate-500">Click to select a file or drag and drop</p>
                    </div>
                </div>

                <!-- Upload Button -->
                <button 
                    type="submit"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition"
                >
                    Upload File
                </button>
            </form>

            <!-- Upload Status -->
            <div id="uploadStatus" class="mt-4 hidden"></div>
            </form>
            </div>

        <!-- Files Management -->
        <div id="filesSection" class="bg-white rounded-lg shadow-md p-6 hidden">
            <h2 class="text-2xl font-bold text-slate-900 mb-6">üìÅ Your Files</h2>

            <!-- Browse Controls -->
            <div class="mb-6 flex gap-4">
                <div class="flex-1">
                    <select 
                        id="bucketBrowse" 
                        class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    >
                        <option value="">-- Select a bucket to browse --</option>
                    </select>
                </div>
                <div class="flex-1">
                    <select id="providerBrowse" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">-- Select provider --</option>
                    </select>
                </div>
                <button 
                    onclick="browseFiles()"
                    class="bg-slate-600 hover:bg-slate-700 text-white font-semibold py-2 px-6 rounded-lg transition"
                >
                    Browse
                </button>
            </div>

            <!-- Files List -->
            <div id="filesList" class="space-y-3">
                <p class="text-slate-500 text-center py-8">Select a provider and bucket to view files</p>
            </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Notifications -->
<div id="toastContainer" class="fixed bottom-4 right-4 space-y-3"></div>

<script>
// Switch between tabs
function switchDashboardTab(tab) {
    // Hide all tabs
    document.getElementById('bucket-tab').classList.add('hidden');
    document.getElementById('files-tab').classList.add('hidden');
    
    // Remove active state from all buttons
    document.getElementById('tab-buckets').classList.remove('border-b-2', 'border-blue-600', 'text-blue-600');
    document.getElementById('tab-buckets').classList.add('border-transparent', 'text-slate-600');
    
    document.getElementById('tab-files').classList.remove('border-b-2', 'border-blue-600', 'text-blue-600');
    document.getElementById('tab-files').classList.add('border-transparent', 'text-slate-600');
    
    // Show selected tab
    if (tab === 'buckets') {
        document.getElementById('bucket-tab').classList.remove('hidden');
        document.getElementById('tab-buckets').classList.add('border-b-2', 'border-blue-600', 'text-blue-600');
        document.getElementById('tab-buckets').classList.remove('border-transparent', 'text-slate-600');
    } else if (tab === 'files') {
        document.getElementById('files-tab').classList.remove('hidden');
        document.getElementById('tab-files').classList.add('border-b-2', 'border-blue-600', 'text-blue-600');
        document.getElementById('tab-files').classList.remove('border-transparent', 'text-slate-600');
    }
}

// Load and display managed buckets
function loadManagedBuckets() {
    axios.get('/user/managed-buckets')
        .then(response => {
            const buckets = response.data.buckets || [];
            const container = document.getElementById('approvedBucketsList');
            
            console.log('üìä Managed Buckets Loaded:', {
                count: buckets.length,
                buckets: buckets.map(b => ({ name: b.bucket_name, provider: b.provider_name }))
            });
            
            // Update badge count
            document.getElementById('bucket-badge').textContent = buckets.length;
            
            if (buckets.length === 0) {
                console.log('üîí No approved buckets - hiding upload UI');
                container.innerHTML = `
                    <div class="text-center py-8">
                        <p class="text-slate-600 mb-4">No approved buckets yet</p>
                        <a href="{{ url_for('user_bucket_management_ui') }}" class="text-blue-600 hover:text-blue-700 font-semibold">
                            Request your first bucket ‚Üí
                        </a>
                    </div>
                `;
                // Hide upload section when no buckets
                document.getElementById('uploadSection').classList.add('hidden');
                document.getElementById('filesSection').classList.add('hidden');
                document.getElementById('noBucketsMessage').classList.remove('hidden');
            } else {
                console.log('‚úÖ Approved buckets found - showing upload UI');
                
                // Check availability for each bucket
                const bucketChecks = buckets.map(bucket => 
                    axios.get(`/user/check-bucket-availability/${bucket.provider_id}/${bucket.bucket_name}`)
                        .then(res => ({
                            ...bucket,
                            available: res.data.available
                        }))
                        .catch(() => ({
                            ...bucket,
                            available: false
                        }))
                );
                
                Promise.all(bucketChecks)
                    .then(bucketsList => {
                        // Store all managed buckets globally for filtering by provider
                        allManagedBuckets = bucketsList;
                        
                        // Show upload section when buckets exist
                        document.getElementById('uploadSection').classList.remove('hidden');
                        document.getElementById('filesSection').classList.remove('hidden');
                        document.getElementById('noBucketsMessage').classList.add('hidden');
                        
                        // Display buckets
                        container.innerHTML = bucketsList.map(bucket => `
                            <div class="border ${bucket.available ? 'border-slate-200 hover:bg-slate-50' : 'border-red-200 bg-red-50'} rounded-lg p-4 transition">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <div class="flex items-center gap-2">
                                            <h4 class="font-semibold ${bucket.available ? 'text-slate-900' : 'text-red-800'}">${bucket.bucket_name}</h4>
                                            ${!bucket.available ? '<span class="bg-red-200 text-red-800 px-2 py-0.5 rounded text-xs font-semibold">Unavailable</span>' : ''}
                                        </div>
                                        <p class="text-sm ${bucket.available ? 'text-slate-600' : 'text-red-700'}">${bucket.provider_display_name} (${bucket.provider_type})</p>
                                    </div>
                                    <div class="text-right">
                                        ${bucket.available ? `
                                            <div class="flex gap-2 flex-wrap justify-end">
                                                ${bucket.allowed_actions.includes('s3:GetObject') ? '<span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs font-semibold">Download</span>' : ''}
                                                ${bucket.allowed_actions.includes('s3:PutObject') ? '<span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs font-semibold">Upload</span>' : ''}
                                                ${bucket.allowed_actions.includes('s3:DeleteObject') ? '<span class="bg-red-100 text-red-800 px-2 py-1 rounded text-xs font-semibold">Delete</span>' : ''}
                                            </div>
                                        ` : `
                                            <p class="text-sm text-red-700 font-semibold">No longer exists in cloud</p>
                                        `}
                                    </div>
                                </div>
                            </div>
                        `).join('');
                    });
            }
        })
        .catch(error => {
            console.error('‚ùå Error loading managed buckets:', error);
            document.getElementById('approvedBucketsList').innerHTML = '<p class="text-red-600 text-center py-8">Error loading buckets</p>';
        });
}

// Load providers on page load
document.addEventListener('DOMContentLoaded', function() {
    loadProviders();
    loadManagedBuckets();
});

// Load providers
async function loadProviders() {
    try {
        const response = await fetch('/user/providers');
        const data = await response.json();
        
        if (data.success) {
            const selectUpload = document.getElementById('providerSelect');
            const selectBrowse = document.getElementById('providerBrowse');
            
            // Clear existing options
            selectUpload.innerHTML = '<option value="">-- Choose a provider --</option>';
            selectBrowse.innerHTML = '<option value="">-- Select provider --</option>';
            
            // Add providers
            data.providers.forEach(provider => {
                const option = document.createElement('option');
                option.value = provider.id;
                option.textContent = `${provider.display_name} (${provider.type_label})`;
                selectUpload.appendChild(option.cloneNode(true));
                selectBrowse.appendChild(option);
            });
            
            // Add event listeners for provider selection changes
            selectUpload.addEventListener('change', updateUploadBucketDropdown);
            selectBrowse.addEventListener('change', updateBrowseBucketDropdown);
        }
    } catch (error) {
        showToast('Error loading providers: ' + error.message, 'error');
    }
}

// Store all managed buckets for filtering
let allManagedBuckets = [];

// Update bucket dropdown when provider changes (Upload form)
function updateUploadBucketDropdown() {
    const providerId = document.getElementById('providerSelect').value;
    const bucketSelect = document.getElementById('bucketName');
    
    bucketSelect.innerHTML = '<option value="">-- Select an approved bucket --</option>';
    
    if (!providerId) {
        return;
    }
    
    // Filter buckets for this provider
    const providerBuckets = allManagedBuckets.filter(b => b.provider_id == providerId && b.available);
    
    providerBuckets.forEach(bucket => {
        const option = document.createElement('option');
        option.value = bucket.bucket_name;
        option.textContent = bucket.bucket_name;
        bucketSelect.appendChild(option);
    });
    
    if (providerBuckets.length === 0) {
        const option = document.createElement('option');
        option.value = '';
        option.textContent = '-- No available buckets --';
        option.disabled = true;
        bucketSelect.appendChild(option);
    }
}

// Update bucket dropdown when provider changes (Browse form)
function updateBrowseBucketDropdown() {
    const providerId = document.getElementById('providerBrowse').value;
    const bucketSelect = document.getElementById('bucketBrowse');
    
    bucketSelect.innerHTML = '<option value="">-- Select a bucket to browse --</option>';
    
    if (!providerId) {
        return;
    }
    
    // Filter buckets for this provider
    const providerBuckets = allManagedBuckets.filter(b => b.provider_id == providerId && b.available);
    
    providerBuckets.forEach(bucket => {
        const option = document.createElement('option');
        option.value = bucket.bucket_name;
        option.textContent = bucket.bucket_name;
        bucketSelect.appendChild(option);
    });
    
    if (providerBuckets.length === 0) {
        const option = document.createElement('option');
        option.value = '';
        option.textContent = '-- No available buckets --';
        option.disabled = true;
        bucketSelect.appendChild(option);
    }
}

// Upload form submission
document.getElementById('uploadForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const providerId = document.getElementById('providerSelect').value;
    const bucketName = document.getElementById('bucketName').value;
    const file = document.getElementById('fileInput').files[0];
    
    if (!providerId) {
        showToast('‚ùå Please select a provider', 'error');
        return;
    }
    
    if (!bucketName) {
        showToast('‚ùå Please select a bucket', 'error');
        return;
    }
    
    if (!file) {
        showToast('‚ùå Please select a file to upload', 'error');
        return;
    }
    
    const formData = new FormData();
    formData.append('provider_id', providerId);
    formData.append('bucket_name', bucketName);
    formData.append('file', file);
    
    try {
        const response = await fetch('/user/upload', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast(`‚úì ${data.message}`, 'success');
            document.getElementById('uploadForm').reset();
        } else {
            showToast(`‚úó ${data.error}`, 'error');
        }
    } catch (error) {
        showToast('Upload error: ' + error.message, 'error');
    }
});

// Browse files
async function browseFiles() {
    const providerId = document.getElementById('providerBrowse').value;
    const bucketName = document.getElementById('bucketBrowse').value;
    
    if (!providerId) {
        showToast('‚ùå Please select a provider', 'error');
        return;
    }
    
    if (!bucketName) {
        showToast('‚ùå Please select a bucket to browse', 'error');
        return;
    }
    
    try {
        const response = await fetch('/user/list-files', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                provider_id: providerId,
                bucket_name: bucketName
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            displayFiles(data.files, providerId, bucketName);
        } else {
            showToast(`‚úó ${data.error}`, 'error');
        }
    } catch (error) {
        showToast('Error listing files: ' + error.message, 'error');
    }
}

// Display files
function displayFiles(files, providerId, bucketName) {
    const filesList = document.getElementById('filesList');
    
    if (files.length === 0) {
        filesList.innerHTML = '<p class="text-slate-500 text-center py-8">No files found in this bucket</p>';
        return;
    }
    
    filesList.innerHTML = files.map(file => `
        <div class="flex items-center justify-between p-4 bg-slate-50 rounded-lg border border-slate-200 hover:bg-slate-100 transition">
            <div class="flex-1">
                <p class="font-semibold text-slate-900">${file.name}</p>
                <p class="text-sm text-slate-500">${formatFileSize(file.size)}</p>
            </div>
            <div class="flex gap-2">
                <button 
                    onclick="downloadFile(${providerId}, '${bucketName}', '${file.name}')"
                    class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded transition"
                >
                    ‚¨áÔ∏è Download
                </button>
                <button 
                    onclick="shareFile(${providerId}, '${bucketName}', '${file.name}')"
                    class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded transition"
                >
                    üîó Share
                </button>
                <button 
                    onclick="deleteFile(${providerId}, '${bucketName}', '${file.name}')"
                    class="bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded transition"
                >
                    üóëÔ∏è Delete
                </button>
            </div>
        </div>
    `).join('');
}

// Download file
function downloadFile(providerId, bucketName, filename) {
    const encodedFilename = encodeURIComponent(filename);
    window.location.href = `/user/download/${providerId}/${encodedFilename}?bucket=${encodeURIComponent(bucketName)}`;
}

// Share file
async function shareFile(providerId, bucketName, filename) {
    try {
        const response = await fetch('/user/get-share-url', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                provider_id: providerId,
                bucket_name: bucketName,
                filename: filename,
                expires_in: 3600
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Copy URL to clipboard
            navigator.clipboard.writeText(data.url);
            showToast('‚úì Share link copied to clipboard (expires in 1 hour)', 'success');
        } else {
            showToast(`‚úó ${data.error}`, 'error');
        }
    } catch (error) {
        showToast('Error generating share URL: ' + error.message, 'error');
    }
}

// Delete file
async function deleteFile(providerId, bucketName, filename) {
    if (!confirm(`Are you sure you want to delete "${filename}"?`)) {
        return;
    }
    
    try {
        const response = await fetch('/user/delete', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                provider_id: providerId,
                bucket_name: bucketName,
                filename: filename
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('‚úì File deleted successfully', 'success');
            browseFiles(); // Refresh list
        } else {
            showToast(`‚úó ${data.error}`, 'error');
        }
    } catch (error) {
        showToast('Error deleting file: ' + error.message, 'error');
    }
}

// Show toast notification
function showToast(message, type = 'info') {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    
    const bgColor = {
        'success': 'bg-green-500',
        'error': 'bg-red-500',
        'info': 'bg-blue-500'
    }[type] || 'bg-blue-500';
    
    toast.className = `${bgColor} text-white px-6 py-3 rounded-lg shadow-lg animate-fade-in`;
    toast.textContent = message;
    container.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 4000);
}

// Format file size
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}
</script>

<style>
@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.animate-fade-in {
    animation: fadeIn 0.3s ease-out;
}
</style>
{% endblock %}